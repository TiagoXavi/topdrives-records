import{n as m,d as f,r as h,R as _,q as g,o as p,s as T,f as D}from"./components-DpxtCXPw.js";import{a as v}from"./index-C8gjSc4W.js";const C={name:"MainDownTimes",components:{BaseCardGallery:p,BaseConfigCheckBox:g,Row:_,BaseCard:h,BaseDialog:f},props:{test:{type:Boolean,default:!1}},data(){return{loading:!1,ridLoading:null,downTimes:{},downTimesClear:{},all_cars:v,all_cars_obj:{},showBigCards:!0,tracksRepo:D,campaign:T,user:null,unsubscribe:null,voteLoading:!1,confirmDelete:{dialog:!1,msg:"Confirm delete?",actionLabel:"Delete",action:null,loading:!1,classe:""},showCarsFix:!0}},watch:{},beforeMount(){this.all_cars.map(a=>{this.all_cars_obj[a.rid]=a})},mounted(){let a=this;this.getDownTimes(),this.user=this.$store.state.user,a.unsubscribe=a.$store.subscribe(e=>{e.type=="CHANGE_USER"&&(a.user=e.payload.user),e.type=="LOGOUT"&&(a.user=null)})},beforeDestroy(){this.unsubscribe()},computed:{userTimes(){return this.$route.params.username}},methods:{getDownTimes(){this.loading=!1;let a="/downTimes";this.userTimes&&(a=`/timesUser/${this.userTimes}`),axios.get(Vue.preUrl+a).then(e=>{this.downTimes=e.data,this.downTimesClear={},Object.keys(this.downTimes).map(t=>{this.downTimesClear[t]=this.downTimes[t].map(s=>({rid:s.rid,selectedTune:s.selectedTune,track:s.track})),this.frontCompleteCar(this.all_cars_obj[t]),this.buildDataStructure(this.all_cars_obj[t],this.downTimes[t]),this.downTimes[t].map(s=>{Vue.set(s,"resolvedTracks",this.validateTracks([s.track]));{let i=[],o=[];this.campaign.map((l,r)=>{l.matches.map((n,c)=>{n.trackset.map((d,u)=>{d===s.track&&o.push({city:l.name,icity:r,imatch:c,irace:u,code:`${r}${c}`})})})}),i.push(o),s.resolvedTracks.map((l,r)=>{let n;i[r].map(c=>{(!n||this.isChamp(n.city)&&!this.isChamp(c.city)||c.irace<n.irace&&!this.isChamp(c.city)||c.irace<=n.irace&&c.icity>n.icity||c.irace<=n.irace&&c.imatch>n.imatch)&&(n=c)}),n?(l.campaign=`${n.city} ${n.imatch+1}`,this.isChamp(n.city)||(l.campaignNum=n.irace+1)):l.campaign="Not in campaign"})}})}),this.showCarsFix=!1,this.$nextTick().then(()=>{this.showCarsFix=!0})}).catch(e=>{this.loading=!1,console.log(e)})},validateTracks(a,e=!1){let t=[],s,i,o=[];if(a.map(l=>{this.tracksRepo.find(r=>{if(l.slice(0,-4)!==r.id)return!1;r.types.find(n=>{if(l===`${r.id}_a${n}`)return e&&r.group?(s=r.group,i=n):t.push({name:r.name,id:r.id,surface:n[0],cond:n[1],code:`${r.id}_a${n}`}),!0})})}),e)this.tracksRepo.map(l=>{s===l.group&&l.types.includes(i)&&o.push(`${l.id}_a${i}`)}),this.toggleTrackSet(o);else return t},isChamp(a){return a.startsWith("SN")||a.startsWith("YB")},changeTime(a,e){let t=this,s=a.car,i=a.selectedTune,o=a.track,l=e.number;s.dataToSave||Vue.set(s,"dataToSave",{}),s.dataToSave[i]||Vue.set(s.dataToSave,i,{}),s.dataToSave[i].times||Vue.set(s.dataToSave[i],"times",{}),s.dataToSave[i].times[o]||Vue.set(s.dataToSave[i].times,o,{}),Vue.set(s.data[i].times[o],"t",l),Vue.set(s.data[i].times[o],"u",t.user.username),Vue.set(s.data[i].times[o],"down",[]),Vue.set(s.data[i].times[o],"up",[]),Vue.set(s.dataToSave[i].times[o],"t",l)},deleteTime(a,e){let t=this,s=function(){t.confirmDelete.loading=!0,t.ridLoading=a.rid,axios.post(Vue.preUrl+"/deleteTime",{rid:a.rid,tune:a.selectedTune,track:a.track}).then(i=>{t.confirmDelete.dialog=!1,t.getDownTimes(),t.$store.commit("DEFINE_SNACK",{active:!0,correct:!0,text:t.$t("m_deleteSuccess")})}).catch(i=>{console.log(i)}).then(()=>{t.confirmDelete.loading=!1,t.ridLoading=null})};this.confirmDelete={dialog:!0,msg:`Delete '${a.track}' time of ${a.rid}?`,actionLabel:"Delete",action:s,loading:!1,classe:"D_ButtonRed"}},saveRid(a){this.ridLoading=a;let e=[];this.downTimes[a].map(t=>{t.car.dataToSave&&e.push({rid:a,data:t.car.dataToSave})}),axios.post(Vue.preUrl+"/update",e).then(t=>{this.getDownTimes()}).catch(t=>{console.log(t)}).then(()=>{this.ridLoading=null})},outsideClick(){this.$store.commit("HIDE_DETAIL")},askDeleteAllTimes(){let a=this,e=function(){a.deleteAllTimes()};this.confirmDelete={dialog:!0,msg:"Delete all times?",actionLabel:"Delete",action:e,loading:!1,classe:"D_ButtonRed"}},deleteAllTimes(){this.loading=!0,this.confirmDelete.loading=!0;let a={items:this.downTimesClear};axios.post(Vue.preUrl+"/deleteCollectionOfTimes",a).then(e=>{this.loading=!1,this.confirmDelete.dialog=!1,this.confirmDelete.loading=!1}).catch(e=>{this.loading=!1,this.confirmDelete.loading=!1,console.log(e),this.$store.commit("DEFINE_SNACK",{active:!0,error:!0,text:e,type:"error"})})},exportCar(a){let e=[];a.map(t=>{e.push(t.selectedTune)}),e=[...new Set(e)],e.map(t=>{let s=`${window.location.origin}?share=`;a.map(i=>{i.selectedTune===t&&(s+=`~K${i.track}`)}),s+=`~C${a[0].rid}~T${t}`,console.log(s)})},frontCompleteCar(a){Vue.set(a,"photo",Vue.carPhoto(a)),Vue.set(a,"car",JSON.parse(JSON.stringify(this.all_cars.find(e=>e.rid===a.rid)))),Vue.set(a,"color",Vue.resolveClass(a.car.rq,a.car.class,"color"))},buildDataStructure(a,e){let t=e.track,s=e.selectedTune;a.data||Vue.set(a,"data",{}),a.data[s]||Vue.set(a.data,s,{}),a.data[s].times||Vue.set(a.data[s],"times",{}),a.data[s].times[t]||Vue.set(a.data[s].times,t,{}),Vue.set(a.data[s].times[t],"t",e.time),Vue.set(a.data[s].times[t],"u",e.user),Vue.set(a.data[s].times[t],"down",e.down||[]),Vue.set(a.data[s].times[t],"up",e.up||[])}}};var w=function(){var e=this,t=e._self._c;return t("div",{staticClass:"MainDownTimes_Layout"},[t("div",{staticClass:"MainDownTimes_BlockBack",on:{click:function(s){return s.stopPropagation(),e.outsideClick()}}}),t("div",{staticClass:"MainDownTimes_Header"},[t("BaseDialog",{attrs:{active:e.confirmDelete.dialog,transparent:!1,lazy:!0,zindex:"101","max-width":"420px","min-width":"240px"},on:{close:function(s){e.confirmDelete.dialog=!1}}},[t("div",{staticStyle:{}},[t("div",{staticClass:"Main_DialogMessage"},[e._v(e._s(e.confirmDelete.msg))]),t("div",{staticClass:"Main_DialogBottom"},[t("button",{staticClass:"D_Button Main_OptionsButton",on:{click:function(s){e.confirmDelete.dialog=!1}}},[t("span",[e._v(e._s(e.$t("m_cancel")))])]),t("button",{staticClass:"D_Button Main_OptionsButton",class:`${e.confirmDelete.loading?"D_Button_Loading ":""}${e.confirmDelete.classe}`,attrs:{disabled:e.confirmDelete.loading},on:{click:e.confirmDelete.action}},[t("span",[e._v(e._s(e.confirmDelete.actionLabel))])])])])])],1),e.showCarsFix?t("div",{staticClass:"MainDownTimes_Body"},[t("div",{staticClass:"MainDownTimes_ D_Center2",staticStyle:{position:"relative","margin-bottom":"20px"}},[e.user&&e.user.username==="TiagoXavi"?t("button",{staticClass:"D_Button D_ButtonDark D_ButtonDark2 D_ButtonRed",on:{click:function(s){return e.askDeleteAllTimes()}}},[e._v(" Delete all ")]):e._e()]),e._l(e.downTimes,function(s,i){return t("div",{staticClass:"MainDownTimes_Car"},[t("div",{staticClass:"MainDownTimes_CarTop"},[t("div",{staticClass:"MainDownTimes_CarBody",class:{MainDownTimes_BodyBig:e.showBigCards}},[t("div",{staticClass:"MainDownTimes_CarItem",style:`--color: ${e.all_cars_obj[i].color}`},[e.showBigCards?t("BaseCard",{attrs:{car:e.all_cars_obj[i].car,"fix-back":!0,downloadLoading:!1,needSave:!1,draggable:!1,cgOppo:!1,hideClose:!0,showResetTune:!0},on:{refreshTune:function(o){return e.exportCar(s)},delete:function(o){e.race.car=void 0,e.race.rid=null,e.calcRaceResult(e.race)}}}):t("div",{staticClass:"MainDownTimes_CarCard"},[t("div",{staticClass:"MainDownTimes_BankPhoto"},[t("img",{staticClass:"MainDownTimes_BankPhotoImg",attrs:{src:e.all_cars_obj[i].photo,loading:"lazy",alt:""}})]),t("div",{staticClass:"MainDownTimes_RQ"},[e._v(e._s(e.all_cars_obj[i].rq))])])],1)])]),t("div",{staticClass:"MainDownTimes_CarBottom"},e._l(s,function(o){return t("div",{staticClass:"MainDownTimes_CarTime"},[t("div",{staticClass:"MainDownTimes_CarLeft"},[e._v(e._s(o.selectedTune))]),t("div",{staticClass:"MainDownTimes_CarRight"},[t("Row",{staticClass:"Cg_TrackBox",attrs:{list:o.resolvedTracks,loggedin:!!e.user,user:e.user,options:e.user&&e.user.mod,cg:!0,type:"tracks"}}),t("Row",{attrs:{car:o,list:o.resolvedTracks,loggedin:!!e.user,user:e.user,voteLoading:e.voteLoading,cg:!0,cgOppo:!1,cgTime:o.time,customData:e.all_cars_obj[i].car.data,forceDisabled:!e.user||!e.user.mod,type:"times"},on:{deleteTime:function(l){return e.deleteTime(o,l)},changeTime:function(l){return e.changeTime(e.all_cars_obj[i].car,l)}}}),e.all_cars_obj[i].car.dataToSave?t("div",{staticClass:"MainDownTimes_SaveBox"},[t("button",{staticClass:"D_Button Main_SaveAllButton",class:{D_Button_Loading:e.ridLoading===i},on:{click:function(l){return e.saveRid(i)}}},[e._v(e._s(e.$t("m_save")))])]):e._e()],1)])}),0)])})],2):e._e()])},k=[],b=m(C,w,k,!1,null,null);const M=b.exports;export{M as default};
