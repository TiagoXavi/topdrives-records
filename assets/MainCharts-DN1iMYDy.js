import{B as f}from"./BaseSearchTrackDialog-CBBcnIL0.js";import{n as m,a as _,e as g,k as C,t as k}from"./index-BR-PFC2m.js";import{B as T}from"./BaseFilterDescription-BffbdYBC.js";import{b as D}from"./BaseFilterDialog-b2RE-qND.js";import{H as v}from"./Highcharts-oW5qyxKO.js";import{R as S}from"./Row-DOgu6NRG.js";import"./campaign-Dapxa4yk.js";import"./BaseDualSlider-4dZ1Waol.js";import"./BaseExpandDiv-1VZq3Ohy.js";import"./stock-CLNdE23Z.js";const B={name:"MainCharts",components:{BaseSearchTrackDialog:f,BaseConfigCheckBox:g,BaseFilterDescription:T,BaseFilterDialog:D,Row:S,Highcharts:v,BaseChip:_},props:{test:{type:Boolean,default:!1}},data(){return{tracksRepo:k,all_cars:C,all_cars_obj:{},customTrackDialog:!1,filterDialog:!1,searchTracks:"",chartTrack:!1,chartFilter:{},chartIsFiltering:!1,chartFilterCount:0,chartLoading:!1,chartShowDownvoted:!1,chartHideOutOfFilter:!1,chartResult:[],chartTunes:[],highchartsConfig:{},user:null,unsubscribe:null,counter:0}},watch:{},beforeMount(){let a=window.localStorage.getItem("chartShowDownvoted");a&&(a=JSON.parse(a),this.chartShowDownvoted=a);let t=window.localStorage.getItem("chartHideOutOfFilter");t&&(t=JSON.parse(t),this.chartHideOutOfFilter=t),this.all_cars.map(e=>{this.all_cars_obj[e.rid]=e})},mounted(){let a=this;this.user=this.$store.state.user,a.unsubscribe=a.$store.subscribe(t=>{t.type=="CHANGE_USER"&&(a.user=t.payload.user),t.type=="LOGOUT"&&(a.user=null)})},beforeDestroy(){this.unsubscribe()},computed:{},methods:{openDialogTrackSearch(){this.customTrackDialog=!0,setTimeout(()=>{try{document.querySelector("#SearchTrackInput").focus()}catch{}},10)},closeDialogTrackSearch(){this.customTrackDialog=!1,this.searchTracks=""},toggleTrack(a,t={}){this.closeDialogTrackSearch()},getResolvedTrack(a){this.chartTrack=a},openChartOfDialog(){this.filterDialog=!0},closeChartOfDialog(){this.filterDialog=!1},updateChartFilter(a){this.chartFilter=a,this.filterDialog=!1},chartAnalyse(){this.chartTrack.code&&this.$store.commit("FILTER_EMIT_RIDS",{total:5e3})},chartAnalyseFinish(a){this.chartLoading=!0,axios.post(Vue.preUrl+"/chart",{track:this.chartTrack.code,includeDownvotes:this.chartShowDownvoted,tunes:this.chartTunes}).then(t=>{this.chartResult=t.data,this.prepareChart(a),t.data.length===0&&this.$store.commit("DEFINE_SNACK",{active:!0,error:!0,text:this.$t("m_noTimesFound"),type:"error"})}).catch(t=>{console.log(t),this.$store.commit("DEFINE_SNACK",{active:!0,error:!0,text:t,type:"error"})}).then(()=>{this.chartLoading=!1})},prepareChart(a){let t=this,e=this.chartResult,s=[],i={};a.map(r=>{i[r.rid]=!0});let n={S:[],A:[],B:[],C:[],D:[],E:[],F:[]},h={S:[],A:[],B:[],C:[],D:[],E:[],F:[]},l={S:[],A:[],B:[],C:[],D:[],E:[],F:[]};e.map(r=>{l[r.class].push(r.time)}),Object.keys(l).map(r=>{l[r].sort((c,o)=>c-o)}),Object.keys(l).map(r=>{n[r]=this.groupProximity(l[r]),l[r].length>10&&n[r].map((c,o)=>{(o===0||o===n[r].length-1)&&(typeof c=="number"&&h[r].push(c),typeof c=="object"&&c.length<3&&c.length>0&&c.map(u=>{h[r].push(u)}))})}),e=e.filter(r=>{if(r.car=t.all_cars_obj[r.rid],h[r.class].includes(r.time)&&r.rq!==10&&!this.chartTrack.code.includes("drag")&&(r.car.tyres!=="Slick"||this.chartTrack.code.includes("_a00"))&&(r.car.tyres!=="Off-road"||!this.chartTrack.code.includes("_a01"))&&r.rid!=="Land_Rover_Series_1_1948")if(this.user.canDelete)r.suspect=!0;else return!1;return!0}),e.map((r,c)=>{if(this.chartHideOutOfFilter&&!i[r.rid])return;let o=s.find(p=>p.name===r.class);o||(s.push({name:r.class,color:Vue.resolveClass(r.rq,r.class,"color")}),o=s[s.length-1]),o.data||(o.data=[]);let u=Vue.carPhoto(r);o.data.push({y:r.rq,x:r.time,name:`${r.name} (${r.tune})`,className:`${i[r.rid]?"":"Highcharts_HidePoint "}${r.suspect?"Highcharts_Suspect ":""}`,custom:{...r,photo:u,color:Vue.resolveClass(r.rq,r.car.class,"color"),user:r.user}})});var d="ontouchstart"in window||navigator.msMaxTouchPoints;this.highchartsConfig={boost:{seriesThreshold:s.length,useGPUTranslations:!0,usePreAllocated:!0},chart:{type:"scatter"},legend:{enabled:!1},series:s,yAxis:{min:0,max:110,allowDecimals:!1,labels:{format:"RQ{text}"}},xAxis:{type:"logarithmic",allowDecimals:!1,labels:{format:"{text}s"}},tooltip:{snap:d?50:10},plotOptions:{series:{stickyTracking:!!d,turboThreshold:2e3},scatter:{boostThreshold:2e3}}}},detailClick(a){var t="ontouchstart"in window||navigator.msMaxTouchPoints;if(a.shiftKey)this.deleteTime(a.point.custom.rid,a.point.custom.tune);else if(!t){let e=`https://www.topdrivesrecords.com?share=~K${this.chartTrack.code}~C${a.point.custom.rid}~T${a.point.custom.tune}`;window.open(e,"_blank").focus()}},deleteTime(a,t){axios.post(Vue.preUrl+"/deleteTime",{rid:a,tune:t,track:this.chartTrack.code}).then(e=>{this.chartAnalyse(),this.$store.commit("DEFINE_SNACK",{active:!0,correct:!0,text:this.$t("m_deleteSuccess")})}).catch(e=>{console.log(e),this.$store.commit("DEFINE_SNACK",{active:!0,error:!0,text:e,type:"error"})}).then(()=>{})},median(a){if(a.length==0)return;a.sort((s,i)=>s-i);const t=Math.floor(a.length/2);return a.length%2===1?a[t]:(a[t-1]+a[t])/2},groupProximity(a){return a.reduce(function(t,e,s){return s!=0?e-a[s-1]<(e+a[s-1])/2*.1?t[t.length-1].push(e):t.push([e]):t.push([e]),s==a.length-1&&(t=t.map(i=>i.length==1?i[0]:i)),t},[])}}};var b=function(){var t=this,e=t._self._c;return e("div",{staticClass:"MainCharts_Layout"},[e("div",{staticClass:"MainCharts_Header"},[e("div",{staticClass:"Main_ChartTrackBox",class:{Main_ChartTrackBoxSelected:t.chartTrack}},[e("div",{staticClass:"Cg_Track"},[t.chartTrack?e("Row",{staticClass:"Cg_TrackBox",attrs:{list:[t.chartTrack],loggedin:!!t.user,user:t.user,options:!0,cg:!0,normalSize:!0,type:"tracks"}}):t._e(),e("button",{staticClass:"D_Button Car_AddButton Cg_SelectTrackButton",class:{Cg_SelectTrackButtonEdit:t.chartTrack},on:{click:function(s){return t.openDialogTrackSearch()}}},[t.chartTrack?e("i",{staticClass:"ticon-pencil Cg_SelectTrackButtonIcon",attrs:{"aria-hidden":"true"}}):e("span",[t._v(t._s(t.$t("m_selectTrack")))])])],1)]),e("div",{staticClass:"Main_ChartFilter Main_DarkScroll"},[t.chartFilter?[e("div",{staticClass:"Cg_Reqs"},[e("BaseFilterDescription",{attrs:{filter:t.chartFilter,asFilterLabel:!0}})],1)]:t._e(),e("div",{staticClass:"Cg_FilterButtons"},[e("button",{staticClass:"D_Button D_ButtonDark D_ButtonDark2 Cg_TopButton",attrs:{disabled:t.chartLoading},on:{click:function(s){return t.openChartOfDialog()}}},[t._v(t._s(t.chartFilter?t.$t("m_change"):t.$t("m_requirements")))])])],2),!t.user||!t.user.tier||t.user.tier>2?e("div",{staticClass:"Main_SaveGalleryGuide",staticStyle:{"margin-top":"20px"}},[e("span",[t._v(t._s(t.$t("p_patronsOnly",{tier:2}))),e("br"),t._v(t._s(t.$t("p_chartsDescription"))+" "),e("a",{staticClass:"D_Link D_LinkUnder",attrs:{target:"_blank",href:"https://youtu.be/xwMB8BGM2JM"}},[t._v("Youtube")])])]):t._e(),e("div",{staticClass:"Main_ChartTrackBox Main_ChartFilterChipsInside",staticStyle:{"margin-top":"4px"}},[t._l(["332","323","233","111"],function(s,i){return[e("BaseChip",{staticClass:"BaseChip_MinWidth BaseChip_TuneStyle",attrs:{value:s},model:{value:t.chartTunes,callback:function(n){t.chartTunes=n},expression:"chartTunes"}})]})],2),e("BaseConfigCheckBox",{staticClass:"Main_ChartTrackBox",staticStyle:{"margin-top":"3px"},attrs:{name:"chartShowDownvoted",label:t.$t("m_includeDownvote")},model:{value:t.chartShowDownvoted,callback:function(s){t.chartShowDownvoted=s},expression:"chartShowDownvoted"}}),e("BaseConfigCheckBox",{staticClass:"Main_ChartTrackBox",staticStyle:{"margin-top":"3px"},attrs:{name:"chartHideOutOfFilter",label:t.$t("m_chartHideOutOfFilter")},model:{value:t.chartHideOutOfFilter,callback:function(s){t.chartHideOutOfFilter=s},expression:"chartHideOutOfFilter"}}),t.user&&t.user.tier<=2?e("button",{staticClass:"D_Button D_ButtonDark D_ButtonTier2 Main_ChartAnalyzeButton",class:{D_Button_Loading:t.chartLoading},attrs:{disabled:t.chartLoading||!t.chartTrack},on:{click:function(s){return t.chartAnalyse()}}},[e("i",{staticClass:"ticon-crown D_ButtonIcon D_ButtonIcon24",attrs:{"aria-hidden":"true"}}),e("span",[t._v(t._s(t.$t("m_loadChart")))]),e("i",{staticClass:"ticon-arrow_down_3",staticStyle:{"margin-left":"5px"},attrs:{"aria-hidden":"true"}})]):t._e()],1),t.highchartsConfig.chart?e("div",{staticClass:"MainCharts_Body"},[e("Highcharts",{attrs:{config:t.highchartsConfig,counter:t.counter,trackCode:t.chartTrack.code||""},on:{detail:function(s){return t.detailClick(s)}}})],1):t._e(),e("BaseSearchTrackDialog",{attrs:{active:t.customTrackDialog},on:{close:function(s){return t.closeDialogTrackSearch()},toggleTrack:function(s){return t.toggleTrack(s.track,s.e)},resolved:function(s){return t.getResolvedTrack(s)}}}),e("BaseFilterDialog",{attrs:{filterOnly:!0,all_cars:t.all_cars},on:{filterUpdate:function(s){return t.updateChartFilter(s)},listRids:function(s){return t.chartAnalyseFinish(s)}},model:{value:t.filterDialog,callback:function(s){t.filterDialog=s},expression:"filterDialog"}})],1)},w=[],y=m(B,b,w,!1,null,null);const N=y.exports;export{N as default};
