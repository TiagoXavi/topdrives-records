import{n as f,k as _,H as g,R as m,a as C,p as k,q as T,B as D,f as v}from"./components-DpxtCXPw.js";import{a as B}from"./index-C8gjSc4W.js";const S={name:"MainCharts",components:{BaseSearchTrackDialog:D,BaseConfigCheckBox:T,BaseFilterDescription:k,BaseFilterDialog:C,Row:m,Highcharts:g,BaseChip:_},props:{test:{type:Boolean,default:!1}},data(){return{tracksRepo:v,all_cars:B,all_cars_obj:{},customTrackDialog:!1,filterDialog:!1,searchTracks:"",chartTrack:!1,chartFilter:{},chartIsFiltering:!1,chartFilterCount:0,chartLoading:!1,chartShowDownvoted:!1,chartHideOutOfFilter:!1,chartResult:[],chartTunes:[],highchartsConfig:{},user:null,unsubscribe:null,counter:0}},watch:{},beforeMount(){let r=window.localStorage.getItem("chartShowDownvoted");r&&(r=JSON.parse(r),this.chartShowDownvoted=r);let t=window.localStorage.getItem("chartHideOutOfFilter");t&&(t=JSON.parse(t),this.chartHideOutOfFilter=t),this.all_cars.map(e=>{this.all_cars_obj[e.rid]=e})},mounted(){let r=this;this.user=this.$store.state.user,r.unsubscribe=r.$store.subscribe(t=>{t.type=="CHANGE_USER"&&(r.user=t.payload.user),t.type=="LOGOUT"&&(r.user=null)})},beforeDestroy(){this.unsubscribe()},computed:{},methods:{openDialogTrackSearch(){this.customTrackDialog=!0},closeDialogTrackSearch(){this.customTrackDialog=!1,this.searchTracks=""},toggleTrack(r,t={}){this.closeDialogTrackSearch()},getResolvedTrack(r){this.chartTrack=r},openChartOfDialog(){this.filterDialog=!0},closeChartOfDialog(){this.filterDialog=!1},updateChartFilter(r){this.chartFilter=r,this.filterDialog=!1},chartAnalyse(){this.chartTrack.code&&this.$store.commit("FILTER_EMIT_RIDS",{total:5e3})},chartAnalyseFinish(r){this.chartLoading=!0,axios.post(Vue.preUrl+"/chart",{track:this.chartTrack.code,includeDownvotes:this.chartShowDownvoted,tunes:this.chartTunes}).then(t=>{this.chartResult=t.data,this.prepareChart(r),t.data.length===0&&this.$store.commit("DEFINE_SNACK",{active:!0,error:!0,text:this.$t("m_noTimesFound"),type:"error"})}).catch(t=>{console.log(t),this.$store.commit("DEFINE_SNACK",{active:!0,error:!0,text:t,type:"error"})}).then(()=>{this.chartLoading=!1})},prepareChart(r){let t=this,e=this.chartResult,s=[],i={};r.map(a=>{i[a.rid]=!0});let n={S:[],A:[],B:[],C:[],D:[],E:[],F:[]},h={S:[],A:[],B:[],C:[],D:[],E:[],F:[]},l={S:[],A:[],B:[],C:[],D:[],E:[],F:[]};e.map(a=>{l[a.class].push(a.time)}),Object.keys(l).map(a=>{l[a].sort((c,o)=>c-o)}),Object.keys(l).map(a=>{n[a]=this.groupProximity(l[a]),l[a].length>10&&n[a].map((c,o)=>{(o===0||o===n[a].length-1)&&(typeof c=="number"&&h[a].push(c),typeof c=="object"&&c.length<3&&c.length>0&&c.map(u=>{h[a].push(u)}))})}),e=e.filter(a=>{if(a.car=t.all_cars_obj[a.rid],h[a.class].includes(a.time)&&a.rq!==10&&!this.chartTrack.code.includes("drag")&&(a.car.tyres!=="Slick"||this.chartTrack.code.includes("_a00"))&&(a.car.tyres!=="Off-road"||!this.chartTrack.code.includes("_a01"))&&a.rid!=="Land_Rover_Series_1_1948")if(this.user.canDelete)a.suspect=!0;else return!1;return!0}),e.map((a,c)=>{if(this.chartHideOutOfFilter&&!i[a.rid])return;let o=s.find(p=>p.name===a.class);o||(s.push({name:a.class,color:Vue.resolveClass(a.rq,a.class,"color")}),o=s[s.length-1]),o.data||(o.data=[]);let u=Vue.carPhoto(a);o.data.push({y:a.rq,x:a.time,name:`${a.name} (${a.tune})`,className:`${i[a.rid]?"":"Highcharts_HidePoint "}${a.suspect?"Highcharts_Suspect ":""}`,custom:{...a,photo:u,color:Vue.resolveClass(a.rq,a.car.class,"color"),user:a.user}})});var d="ontouchstart"in window||navigator.msMaxTouchPoints;this.highchartsConfig={boost:{seriesThreshold:s.length,useGPUTranslations:!0,usePreAllocated:!0},chart:{type:"scatter"},legend:{enabled:!1},series:s,yAxis:{min:0,max:110,allowDecimals:!1,labels:{format:"RQ{text}"}},xAxis:{type:"logarithmic",allowDecimals:!1,labels:{format:"{text}s"}},tooltip:{snap:d?50:10},plotOptions:{series:{stickyTracking:!!d,turboThreshold:2e3},scatter:{boostThreshold:2e3}}}},detailClick(r){var t="ontouchstart"in window||navigator.msMaxTouchPoints;if(r.shiftKey)this.deleteTime(r.point.custom.rid,r.point.custom.tune);else if(!t){let e=`${window.location.origin}?share=~K${this.chartTrack.code}~C${r.point.custom.rid.replaceAll("+","%2B").replaceAll("&","%26")}~T${r.point.custom.tune}`;window.open(e,"_blank").focus()}},deleteTime(r,t){axios.post(Vue.preUrl+"/deleteTime",{rid:r,tune:t,track:this.chartTrack.code}).then(e=>{this.chartAnalyse(),this.$store.commit("DEFINE_SNACK",{active:!0,correct:!0,text:this.$t("m_deleteSuccess")})}).catch(e=>{console.log(e),this.$store.commit("DEFINE_SNACK",{active:!0,error:!0,text:e,type:"error"})}).then(()=>{})},median(r){if(r.length==0)return;r.sort((s,i)=>s-i);const t=Math.floor(r.length/2);return r.length%2===1?r[t]:(r[t-1]+r[t])/2},groupProximity(r){return r.reduce(function(t,e,s){return s!=0?e-r[s-1]<(e+r[s-1])/2*.1?t[t.length-1].push(e):t.push([e]):t.push([e]),s==r.length-1&&(t=t.map(i=>i.length==1?i[0]:i)),t},[])}}};var b=function(){var t=this,e=t._self._c;return e("div",{staticClass:"MainCharts_Layout"},[e("div",{staticClass:"MainCharts_Header"},[e("div",{staticClass:"Main_ChartTrackBox",class:{Main_ChartTrackBoxSelected:t.chartTrack}},[e("div",{staticClass:"Cg_Track"},[t.chartTrack?e("Row",{staticClass:"Cg_TrackBox",attrs:{list:[t.chartTrack],loggedin:!!t.user,user:t.user,options:!0,cg:!0,normalSize:!0,type:"tracks"}}):t._e(),e("button",{staticClass:"D_Button Car_AddButton Cg_SelectTrackButton",class:{Cg_SelectTrackButtonEdit:t.chartTrack},on:{click:function(s){return t.openDialogTrackSearch()}}},[t.chartTrack?e("i",{staticClass:"ticon-pencil Cg_SelectTrackButtonIcon",attrs:{"aria-hidden":"true"}}):e("span",[t._v(t._s(t.$t("m_selectTrack")))])])],1)]),e("div",{staticClass:"Main_ChartFilter Main_DarkScroll"},[t.chartFilter?[e("div",{staticClass:"Cg_Reqs"},[e("BaseFilterDescription",{attrs:{filter:t.chartFilter,asFilterLabel:!0}})],1)]:t._e(),e("div",{staticClass:"Cg_FilterButtons"},[e("button",{staticClass:"D_Button D_ButtonDark D_ButtonDark2 Cg_TopButton",attrs:{disabled:t.chartLoading},on:{click:function(s){return t.openChartOfDialog()}}},[t._v(t._s(t.chartFilter?t.$t("m_change"):t.$t("m_requirements")))])])],2),!t.user||!t.user.tier||t.user.tier>2?e("div",{staticClass:"Main_SaveGalleryGuide",staticStyle:{"margin-top":"20px"}},[e("span",[t._v(t._s(t.$t("p_patronsOnly",{tier:2}))),e("br"),t._v(t._s(t.$t("p_chartsDescription"))+" "),e("a",{staticClass:"D_Link D_LinkUnder",attrs:{target:"_blank",href:"https://youtu.be/xwMB8BGM2JM"}},[t._v("Youtube")])])]):t._e(),e("div",{staticClass:"Main_ChartTrackBox Main_ChartFilterChipsInside",staticStyle:{"margin-top":"4px"}},[t._l(["332","323","233","111"],function(s,i){return[e("BaseChip",{staticClass:"BaseChip_MinWidth BaseChip_TuneStyle",attrs:{value:s},model:{value:t.chartTunes,callback:function(n){t.chartTunes=n},expression:"chartTunes"}})]})],2),e("BaseConfigCheckBox",{staticClass:"Main_ChartTrackBox",staticStyle:{"margin-top":"3px"},attrs:{name:"chartShowDownvoted",label:t.$t("m_includeDownvote")},model:{value:t.chartShowDownvoted,callback:function(s){t.chartShowDownvoted=s},expression:"chartShowDownvoted"}}),e("BaseConfigCheckBox",{staticClass:"Main_ChartTrackBox",staticStyle:{"margin-top":"3px"},attrs:{name:"chartHideOutOfFilter",label:t.$t("m_chartHideOutOfFilter")},model:{value:t.chartHideOutOfFilter,callback:function(s){t.chartHideOutOfFilter=s},expression:"chartHideOutOfFilter"}}),t.user&&t.user.tier<=2?e("button",{staticClass:"D_Button D_ButtonDark D_ButtonTier2 Main_ChartAnalyzeButton",class:{D_Button_Loading:t.chartLoading},attrs:{disabled:t.chartLoading||!t.chartTrack},on:{click:function(s){return t.chartAnalyse()}}},[e("i",{staticClass:"ticon-crown D_ButtonIcon D_ButtonIcon24",attrs:{"aria-hidden":"true"}}),e("span",[t._v(t._s(t.$t("m_loadChart")))]),e("i",{staticClass:"ticon-arrow_down_3",staticStyle:{"margin-left":"5px"},attrs:{"aria-hidden":"true"}})]):t._e()],1),t.highchartsConfig.chart?e("div",{staticClass:"MainCharts_Body"},[e("Highcharts",{attrs:{config:t.highchartsConfig,counter:t.counter,trackCode:t.chartTrack.code||""},on:{detail:function(s){return t.detailClick(s)}}})],1):t._e(),e("BaseSearchTrackDialog",{attrs:{active:t.customTrackDialog},on:{close:function(s){return t.closeDialogTrackSearch()},toggleTrack:function(s){return t.toggleTrack(s.track,s.e)},resolved:function(s){return t.getResolvedTrack(s)}}}),e("BaseFilterDialog",{attrs:{filterOnly:!0},on:{filterUpdate:function(s){return t.updateChartFilter(s)},listRids:function(s){return t.chartAnalyseFinish(s)}},model:{value:t.filterDialog,callback:function(s){t.filterDialog=s},expression:"filterDialog"}})],1)},w=[],F=f(S,b,w,!1,null,null);const $=F.exports;export{$ as default};
